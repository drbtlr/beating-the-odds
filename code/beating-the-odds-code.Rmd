---
title: "Beating the Odds"
author: "Aaron Butler, Hannah Poquette"
date: "Jun 30, 2018 (Replace with date uploaded to OpenSDP)"
output: 
  html_document:
    theme: simplex
    css: ../includes/styles.css
    highlight: NULL
    keep_md: true
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: false
---

# Implementing a Beating the Odds Analysis 

*A step-by-step guide to implementing a beating the odds analysis using a multilevel framework. Programmed in R*

```{r knitrSetup, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, comment=NA}
# Set options for knitr
library(knitr)
knitr::opts_chunk$set(comment=NA, warning=FALSE, echo=TRUE,
                      root.dir = normalizePath("../"),
                      error=FALSE, message=FALSE, fig.align='center',
                      fig.width=8, fig.height=6, dpi = 144, 
                      fig.path = "../figure/E_", 
                      cache.path = "../cache/E_")
options(width=80)
```

<div class="navbar navbar-default navbar-fixed-top" id="logo">
<div class="container">
<img src="https://opensdp.github.io/assets/images/OpenSDP-Banner_crimson.jpg" style="display: block; margin: 0 auto; height: 115px;">
</div>
</div>

## Getting Started

### Objective

In this guide, you will be able to use statistical models to predict school performance based on the demographic makeup of schools' student populations and compare these predictions with actual school performance. 

### Purpose and Overview of Analyses

School leaders often want to identify promising practices that distinguish high-performing schools from their counterparts and facilitate the transfer of some of these practices to struggling schools. A beating the odds analysis is one approach school leaders can take to identify schools that perform better than expected, given the unique student populations they serve.

The purpose of this guide is to present a data-driven approach to identify beating-the-odds schools. We use multilevel models to predict student performance and school-level effects on that performance. Next, we compare each school's predicted performance to its actual performance. The school is identified as beating the odds if its actual performance is higher than predicted by a statistically significant margin. The procedures presented in this guide parellel those used in a collaborative study by the [Kentucky Department of Education](https://education.ky.gov/) and [REL Appalachia](https://ies.ed.gov/ncee/edlabs/regions/appalachia/).

### Using this Guide

This guide utilizes SDP's ["Faketucky"](https://github.com/opensdp/faketucky), a synthetic dataset based on real student data. While the data is synthetic, the code is not. Schools and districts wanting to conduct their own beating the odds analyses can easily adapt the code provided in this guide to their own data.

Once you have identified analyses that you want to try to replicate or modify, click the "Download" buttons to download R code and sample data. You can make changes to the charts using the code and sample data, or modify the code to work with your own data. If you are familiar with Github, you can click "Go to Repository" and clone the entire repository to your own computer. 

Go to the Participate page to read about more ways to engage with the OpenSDP community or reach out for assistance in adapting this code for your specific context.

### Installing and Loading R Packages

To complete this tutorial, you will need R, R Studio, and the following R packages installed on your machine: 

- `tidyverse`: For convenient data and output manipulation
- `lme4`: To fit multilevel models

To install packages, such as `lme4`, run the following command in the R console:

`install.packages("lme4")`

In addition, this guide will draw from OpenSDP-written functions defined in the `functions.R` document, which is located in the `R` folder of this guide's GitHub repository. Please make sure to have downloaded the entire GitHub repository to run this code.

After you installed your R packages and downloaded this guide's GitHub repository, run the chunk of code below to load them onto your computer.

```{r load-packages, echo=TRUE}
# Load packages
library(tidyverse)
library(lme4)

# Read in some R functions that are convenience wrappers
source("../R/functions.R")
```

### About the Data

This guide uses SDP's ["Faketucky"](https://github.com/opensdp/faketucky) dataset. The Faketucky synthetic college-going analysis file contains high school and college outcome data for two graduating cohorts of approximately 40,000 students. There are no real children in the dataset, but it mirrors the relationships between variables present in real data. The dataset was developed as an offshoot of SDP's [college-going diagnostic for Kentucky](https://cepr.harvard.edu/publications/sdp-college-going-diagnostic-kentucky), using the R [synthpop](https://cran.r-project.org/web/packages/synthpop/index.html) package. In addition, we created school-level aggregates for each variables. The first step of the analysis "Prepare data for analysis" describes the steps to create the school-level variables.

Below is a list of variables and descriptions used in the analyses:

| Variable Name        | Variable Description                                                 |
|:-----------          |:------------------                                                   |
| `first_dist_code`    | Code of first district attended in high school                       |
| `first_dist_name`    | Name of first district attended in high school                       |
| `first_hs_code`      | Code of first high school attended                                   |
| `first_hs_name`      | Name of first high school attended                                   |
| `chrt_ninth`         | Student 9th grade cohort                                             |
| `male`               | Student male indicator                                               |
| `race_ethnicity`     | Student race/ethnicity                                               |
| `frpl_ever_in_hs`    | Student ever received free or reduced price lunch in high school     |
| `sped_ever_in_hs`    | Student ever classified as special ed in high school                 |
| `lep_ever_in_hs`     | Student ever classified as limited English proficiency in high school|
| `gifted_ever_in_hs`  | Student ever classified as gifted in high school                     |
| `scale_score_8_math` | Scaled score of 8th grade math test                                  |
| `scale_score_8_read` | Scaled score of 8th grade reading test                               |
| `scale_score_11_math`| Scaled score of highest math ACT                                     |
| `scale_score_11_read`| Scaled score of highest reading ACT                                  |

#### Loading the Dataset

```{r load-data, echo=FALSE}
# Load "Faketucky" data file
load("../data/faketucky.rda")

# Select variables of interest
my_vars <- c("first_dist_code", "first_dist_name", "first_hs_code", "first_hs_name", 
             "chrt_ninth", "male", "race_ethnicity", "frpl_ever_in_hs", "sped_ever_in_hs", 
             "lep_ever_in_hs", "lep_ever_in_hs", "gifted_ever_in_hs", "scale_score_8_math",
             "scale_score_8_read", "scale_score_11_math", "scale_score_11_read")

faketucky <- faketucky_20160923 %>% 
  select(all_of(my_vars))
```

### Giving Feedback on this Guide
 
This guide is an open-source document hosted on Github and generated using R Markdown. We welcome feedback, corrections, additions, and updates. Please visit the OpenSDP [participate repository](https://opensdp.github.io/participate/) to read our contributor guidelines.

## Analyses

### Identify BTO Schools

**Purpose:** This analysis illustrates how to identify schools that perform better than expected, given the unique student populations they serve, using a beating-the-odds approach. 

**Required Analysis File Variables:**

- `first_hs_code`
- `chrt_ninth`
- `male`
- `race_ethnicity`
- `frpl_ever_in_hs`
- `sped_ever_in_hs`
- `lep_ever_in_hs`
- `gifted_ever_in_hs`
- `scale_score_8_math`
- `scale_score_8_read`
- `scale_score_11_math`
- `scale_score_11_read`

**Analytic Technique:** We use multilevel models to predict student performance and school-level effects on that performance. There a number of benefits to using a multilevel approach over a more traditional approach like ordinary least squares. In particular, a mutlilevel approach allows us to account the hierarchical or nested structure of the data. In this case, student observations and school observations from different years are nested within schools. Additionally, recent beating-the-odds studies have used a multilevel approach with success (e.g., [Bowers, 2015](https://www.tandfonline.com/doi/full/10.1080/13632434.2014.962500); [Partridg, Rudo, & Herrera, 2017](https://eric.ed.gov/?id=ED572602)). 

We listed a few helpful resources on multilevel modeling at the end of this guide. 

**Ask Yourself:**

- What is the structure of my data? How might it influence the model?
- What variables do I want to include in the model? 
- What metrics will I use to determine appropriate model fit?

**A Note on Missing Data:** It is important to determine how you want to address missing data before you begin your analysis. For simplicity, we choose to exclude students with data missing from the analyses. We recommend that you conduct a missing data analysis to determine whether your data is missing completely at random, missing at random, or missing not at random and apply the appropriate strategy to address your missing data. Andrew Gelman's chapter on [Missing-data Imputation in R](http://www.stat.columbia.edu/~gelman/arm/missing.pdf) is a great resource to help you think about your options.   

#### Step 1: Prepare data for analysis

This beathing-the-odds analysis uses a multilevel framework that incoroporates school-level information into the modeling process. To prepare the analytical dataset, we calculated school averages within each school year. These variables when then centered using the grand mean of each variable. 

```{r prep-data, echo=TRUE}
# // Step 1.1: Create school averages within year
df_sch_avg <- faketucky %>% 
  # Create indicator for students identifying as white
  mutate(race_white = ifelse(race_ethnicity == "White", 1, 0)) %>% 
  # Group data by high school and cohort year
  group_by(first_hs_code, chrt_ninth) %>% 
  # Calculate school averages within year
  mutate(sch_male = mean(male, na.rm = TRUE),
         sch_white = mean(race_white, na.rm = TRUE),
         sch_frpl = mean(frpl_ever_in_hs, na.rm = TRUE),
         sch_sped = mean(sped_ever_in_hs, na.rm = TRUE),
         sch_lep = mean(lep_ever_in_hs, na.rm = TRUE),
         sch_gifted = mean(gifted_ever_in_hs, na.rm = TRUE),
         sch_8_math = mean(scale_score_8_math, na.rm = TRUE),
         sch_8_read = mean(scale_score_8_read, na.rm = TRUE)) %>% 
  # Remember to ungroup
  ungroup()

# // Step 1.2: Center variables around grand mean within year
df_center <- df_sch_avg %>% 
  # Flag 2010 cohort
  mutate(flag_2010_cohort = ifelse(chrt_ninth == 2010, 1, 0)) %>% 
  # Group by cohort year
  group_by(chrt_ninth) %>% 
  # Center student-level variables
  mutate(scale_score_8_math_center = scale_score_8_math - mean(scale_score_8_math, na.rm = TRUE),
         scale_score_8_read_center = scale_score_8_read - mean(scale_score_8_read, na.rm = TRUE)) %>% 
  # Calculate within year mean for school-level variables
  mutate(sch_male_mean_year = mean(sch_male, na.rm = TRUE),
         sch_white_mean_year = mean(sch_white, na.rm = TRUE),
         sch_frpl_mean_year = mean(sch_frpl, na.rm = TRUE),
         sch_sped_mean_year = mean(sch_sped, na.rm = TRUE),
         sch_lep_mean_year = mean(sch_lep, na.rm = TRUE),
         sch_gifted_mean_year = mean(sch_gifted, na.rm = TRUE),
         sch_8_math_mean_year = mean(sch_8_math, na.rm = TRUE),
         sch_8_read_mean_year = mean(sch_8_read, na.rm = TRUE)) %>% 
  # Ungroup
  ungroup() %>% 
  # Center school-level variables
  mutate(sch_male_center = sch_male - sch_male_mean_year,
         sch_white_center = sch_white - sch_white_mean_year,
         sch_frpl_center = sch_frpl - sch_frpl_mean_year,
         sch_sped_center = sch_sped - sch_sped_mean_year,
         sch_lep_center = sch_lep - sch_lep_mean_year,
         sch_gifted_center = sch_gifted - sch_gifted_mean_year,
         sch_8_math_center = sch_8_math - sch_8_math_mean_year,
         sch_8_read_center = sch_8_read - sch_8_read_mean_year)
```

#### Step 2: Fit multilevel models

*Add details here.*

```{r fit-models, echo=TRUE}
# // Step 2.1: Fit multilevel models for each subject area  
m_math <- lmer(
  scale_score_11_math ~ 
    male + race_white + frpl_ever_in_hs + sped_ever_in_hs + 
    lep_ever_in_hs + gifted_ever_in_hs + scale_score_8_math_center + 
    sch_male_center + sch_white_center + sch_frpl_center +
    sch_sped_center + sch_lep_center + sch_gifted_center +
    sch_8_math_center + flag_2010_cohort + (1|first_hs_code),
  data = df_center, REML = TRUE
)

m_read <- lmer(
  scale_score_11_read ~ 
    male + race_white + frpl_ever_in_hs + sped_ever_in_hs + 
    lep_ever_in_hs + gifted_ever_in_hs + scale_score_8_read_center + 
    sch_male_center + sch_white_center + sch_frpl_center +
    sch_sped_center + sch_lep_center + sch_gifted_center +
    sch_8_read_center + flag_2010_cohort + (1|first_hs_code),
  data = df_center, REML = TRUE
)

# // Step 2.2: Inspecit summary statistics for model fit
# Examine the coefficients and standard errors for each variable. Ask yourself if
# the estimates are in the range of reasonable possiblity. If not, go back and 
# inspect your dataset and make sure there are no errors in how you processed 
# the data. Also inspect your dataset to make sure that the assumptions of 
# multilevel modeling hold. 
summary(m_math)
summary(m_read)
```

#### Step 3: Calculate statistics for beathing-the-odds scools

*Add details here.*

```{r calc-bto, echo=TRUE}
# // Step 3.1: Access school-level residuals
resids_math <- ranef(m_math)
resids_read <- ranef(m_read)

# // Step 3.2: Create function to flag BTO schools 
calc_bto <- function(.resids) {
  # Imput model residuals
  .resids %>%
    # Store as a dataframe
    data.frame() %>% 
    # Set benchmark at +2 standard deviations
    mutate(pos_bench = condsd * 1.96,
           neg_bench = condsd * -1.96,) %>% 
    # Flag schools that perferm above/below benchmark (i.e., BTOs)
    mutate(sig = ifelse(condval >= pos_bench | condval <= neg_bench, "yes", "no"))
}

# // Step 3.3: Execute function for each subject area
bto_math <- calc_bto(resids_math) %>% 
  # Keep variables of interest. Note we select and rename variables at the same time.
  select(first_hs_code = grp, resid_math = condval, bto_math = sig)
  
bto_read <- calc_bto(resids_read) %>% 
  select(first_hs_code = grp, resid_read = condval, bto_read = sig)

# // Step 3.4: Merge datsets for plotting

# Merge bto datasets
bto_read_math <- left_join(bto_read, bto_math, by = "first_hs_code") %>% 
  # Convert high school work to numeric for merge
  mutate(first_hs_code = as.numeric(first_hs_code))

# Pull school and district info from original dataset
df_names <- faketucky %>% 
  select(first_dist_code, first_hs_code, first_dist_name, first_hs_name) %>% 
  distinct()

# Merge bto and school info datasets
df_bto <- left_join(df_names, bto_read_math, by = "first_hs_code") 
```

#### Step 4: Plot beathing-the-odds scools

*Add details here.*

```{r plot-bto, echo=TRUE}
# Create scatter plot math/read residuals
df_bto %>% 
  mutate(bto_both = ifelse(bto_math == "yes" & bto_read == "yes", "BTO School", "Not a BTO School")) %>% 
  filter(!is.na(bto_both)) %>% 
  ggplot(aes(resid_math, resid_read, color = bto_both)) +
  geom_point(size = 2, alpha = .6) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_color_manual(values = c("#D55E00", "#999999")) +
  theme_bw() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        plot.subtitle = element_text(size = 14),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 11),
        legend.position = "bottom",
        legend.text = element_text(size = 11)) +
  labs(x = "Math",
       y = "Reading",
       color = "",
       title = "BTO Schools in Math and Reading",
       subtitle = "Two-year status model (actual - predicted), 2010")
```

### BTO schools by performance

**Purpose:** *Add purpose here.*

**Required Analysis File Variables:**

- *Add variables here.*

**Ask Yourself**

- *Add question here.*
- *Add question here.*
- *Add question here.*

**Analytic Technique:** *Add description here.*

```{r bto-cuts, echo=TRUE}
# // Step 1: 

# // Step 2: 

```

### BTO schools by student demographics

**Purpose:** *Add purpose here.*

**Required Analysis File Variables:**

- *Add variables here.*

**Ask Yourself**

- *Add question here.*
- *Add question here.*
- *Add question here.*

**Analytic Technique:** *Add description here.*

```{r bto-demos, echo=TRUE}
# // Step 1: 

# // Step 2: 

```

## Resources

Below are a few helpful resources on conducting a beating-the-odds analysis.

- *Add resource here.*
- *Add resource here.*
- *Add resource here.*
- *Add resource here.*